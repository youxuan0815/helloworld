<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ªåƒè›‡æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 800px;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }
        
        h1 {
            color: #4dff91;
            margin-bottom: 10px;
            font-size: 2.8rem;
            text-shadow: 0 0 10px rgba(77, 255, 145, 0.5);
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 25px;
        }
        
        .score-container, .high-score-container, .level-container {
            text-align: center;
        }
        
        .info-label {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4dff91;
        }
        
        .game-area {
            position: relative;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        #game-canvas {
            background-color: #0d1b2a;
            border-radius: 10px;
            border: 2px solid #4dff91;
            box-shadow: 0 0 20px rgba(77, 255, 145, 0.2);
            flex-shrink: 0;
        }
        
        /* è§¸æ§æ§åˆ¶é¢æ¿æ¨£å¼ */
        .touch-control-panel {
            display: none;
            position: relative;
            margin-left: 20px;
            flex-shrink: 0;
        }
        
        .touch-area {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(30, 30, 40, 0.7);
            border: 2px solid rgba(77, 255, 145, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            cursor: pointer;
        }
        
        .direction {
            position: absolute;
            width: 50%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.15s ease;
            user-select: none;
        }
        
        .direction::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            transition: background-color 0.15s ease;
        }
        
        .direction.active::before {
            background: rgba(77, 255, 145, 0.25);
            box-shadow: 0 0 15px rgba(77, 255, 145, 0.3) inset;
        }
        
        .direction.up {
            top: 0;
            left: 25%;
            border-radius: 100% 100% 0 0;
        }
        
        .direction.down {
            bottom: 0;
            left: 25%;
            border-radius: 0 0 100% 100%;
        }
        
        .direction.left {
            top: 25%;
            left: 0;
            border-radius: 100% 0 0 100%;
        }
        
        .direction.right {
            top: 25%;
            right: 0;
            border-radius: 0 100% 100% 0;
        }
        
        .direction .arrow {
            position: relative;
            z-index: 2;
        }
        
        /* ä¸­å¤®åœ“é» */
        .touch-area::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(77, 255, 145, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        button {
            background-color: #4dff91;
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background-color: #33cc73;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .game-instructions {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            margin-top: 10px;
        }
        
        .instructions-title {
            color: #4dff91;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .instructions-list {
            list-style-type: none;
            padding-left: 10px;
        }
        
        .instructions-list li {
            margin-bottom: 8px;
            color: #ccc;
            display: flex;
            align-items: center;
        }
        
        .key {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            margin: 0 5px;
            border-radius: 5px;
            font-family: monospace;
            font-weight: bold;
            color: #4dff91;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            z-index: 10;
        }
        
        .game-over h2 {
            color: #ff4d4d;
            font-size: 3rem;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
        }
        
        .final-score {
            font-size: 2rem;
            margin-bottom: 30px;
            color: #4dff91;
        }
        
        /* ç§»é™¤åŸæœ‰çš„ç§»å‹•æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
        .mobile-controls {
            display: none;
        }
        
        .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 5;
        }
        
        @media (max-width: 768px) {
            .game-info {
                flex-direction: column;
                gap: 15px;
            }
            
            #game-canvas {
                width: 100%;
                height: auto;
            }
            
            /* ç§»å‹•è¨­å‚™é¡¯ç¤ºè§¸æ§é¢æ¿ */
            .touch-control-panel {
                display: block;
                position: absolute;
                right: -50px;
                margin-left: 0;
            }
            
            .buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .game-area {
                justify-content: flex-start;
                overflow: hidden;
            }
            
            .touch-area {
                width: 100px;
                height: 100px;
            }
            
            .direction {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .info-value {
                font-size: 1.7rem;
            }
            
            .touch-control-panel {
                right: -30px;
            }
            
            .touch-area {
                width: 90px;
                height: 90px;
            }
            
            .direction {
                font-size: 1.3rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            /* å¹³æ¿è¨­å‚™é¡¯ç¤ºè§¸æ§é¢æ¿ */
            .touch-control-panel {
                display: block;
                position: absolute;
                right: -60px;
                margin-left: 0;
            }
            
            .touch-area {
                width: 130px;
                height: 130px;
            }
            
            .direction {
                font-size: 2rem;
            }
        }
        
        .apple-icon {
            display: inline-block;
            color: #ff3333;
            font-size: 1.2em;
            margin: 0 3px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>è´ªåƒè›‡æ¸¸æˆ</h1>
            <p>æ§åˆ¶è´ªåƒè›‡åƒæ‰è‹¹æœ<span class="apple-icon">ğŸ</span>ï¼Œé¿å…æ’åˆ°å¢™å£æˆ–è‡ªå·±çš„èº«ä½“ï¼</p>
        </div>
        
        <div class="game-info">
            <div class="score-container">
                <div class="info-label">å½“å‰åˆ†æ•°</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="high-score-container">
                <div class="info-label">æœ€é«˜åˆ†</div>
                <div class="info-value" id="high-score">0</div>
            </div>
            <div class="level-container">
                <div class="info-label">ç­‰çº§</div>
                <div class="info-value" id="level">1</div>
            </div>
        </div>
        
        <div class="game-area">
            <canvas id="game-canvas" width="600" height="400"></canvas>
            
            <!-- å³å´è§¸æ§æ§åˆ¶é¢æ¿ -->
            <div class="touch-control-panel">
                <div class="touch-area" id="touch-area">
                    <div class="direction up" data-direction="up">
                        <span class="arrow">â†‘</span>
                    </div>
                    <div class="direction down" data-direction="down">
                        <span class="arrow">â†“</span>
                    </div>
                    <div class="direction left" data-direction="left">
                        <span class="arrow">â†</span>
                    </div>
                    <div class="direction right" data-direction="right">
                        <span class="arrow">â†’</span>
                    </div>
                </div>
            </div>
            
            <div class="level-up" id="level-up">ç­‰çº§æå‡!</div>
            
            <div class="game-over" id="game-over-screen">
                <h2>æ¸¸æˆç»“æŸ</h2>
                <div class="final-score">å¾—åˆ†: <span id="final-score">0</span></div>
                <button id="restart-btn">é‡æ–°å¼€å§‹</button>
            </div>
        </div>
        
        <div class="controls">
            <div class="buttons">
                <button id="start-btn">å¼€å§‹æ¸¸æˆ</button>
                <button id="pause-btn">æš‚åœæ¸¸æˆ</button>
                <button id="restart-btn2">é‡æ–°å¼€å§‹</button>
            </div>
            
            <!-- ç§»é™¤åŸæœ‰çš„ç§»å‹•æ§åˆ¶æŒ‰éˆ•çµ„ -->
        </div>
        
        <div class="game-instructions">
            <div class="instructions-title">æ¸¸æˆè¯´æ˜</div>
            <ul class="instructions-list">
                <li>ä½¿ç”¨ <span class="key">æ–¹å‘é”®</span> æˆ– <span class="key">WASD</span> æ§åˆ¶è´ªåƒè›‡ç§»åŠ¨</li>
                <li>åœ¨æ‰‹æœºå’Œå¹³æ¿ä¸Šï¼Œä½¿ç”¨<span class="key">å³ä¾§åœ†å½¢è§¦æ§é¢æ¿</span>æ§åˆ¶æ–¹å‘</li>
                <li>è´ªåƒè›‡åƒåˆ° <span class="apple-icon">ğŸ</span> è‹¹æœä¼šå¢åŠ é•¿åº¦å’Œåˆ†æ•°</li>
                <li>æ¯å¾—100åˆ†å‡ä¸€çº§ï¼Œè´ªåƒè›‡é€Ÿåº¦ä¼šåŠ å¿«</li>
                <li>æ’åˆ°å¢™å£æˆ–è‡ªå·±çš„èº«ä½“ä¼šå¯¼è‡´æ¸¸æˆç»“æŸ</li>
                <li>ç‚¹å‡» <span class="key">ç©ºæ ¼é”®</span> å¯ä»¥æš‚åœ/ç»§ç»­æ¸¸æˆ</li>
            </ul>
        </div>
    </div>

    <script>
        // æ¸¸æˆå˜é‡
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('high-score');
        const levelElement = document.getElementById('level');
        const finalScoreElement = document.getElementById('final-score');
        const gameOverScreen = document.getElementById('game-over-screen');
        const levelUpElement = document.getElementById('level-up');
        const startButton = document.getElementById('start-btn');
        const pauseButton = document.getElementById('pause-btn');
        const restartButton = document.getElementById('restart-btn');
        const restartButton2 = document.getElementById('restart-btn2');
        
        // è§¸æ§é¢æ¿å…ƒç´ 
        const touchArea = document.getElementById('touch-area');
        const directionElements = document.querySelectorAll('.direction');
        
        // æ¸¸æˆå¸¸é‡
        const GRID_SIZE = 20;
        const GRID_WIDTH = canvas.width / GRID_SIZE;
        const GRID_HEIGHT = canvas.height / GRID_SIZE;
        
        // è˜‹æœåœ–åƒ
        let appleImage = new Image();
        appleImage.src = 'data:image/svg+xml;base64,' + btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <path d="M50,20 C55,10 65,5 75,10 C85,15 90,25 85,35 C80,45 70,50 60,45 C50,40 45,30 50,20 Z" fill="#FF3333"/>
                <path d="M50,20 C55,10 65,5 75,10 C85,15 90,25 85,35 C80,45 70,50 60,45 C50,40 45,30 50,20 Z" fill="url(#appleGradient)" opacity="0.8"/>
                <path d="M45,15 C40,5 30,5 25,15 C20,25 25,35 35,40 C45,35 50,25 45,15 Z" fill="#8B4513"/>
                <ellipse cx="40" cy="20" rx="3" ry="2" fill="#FFFFFF" opacity="0.7"/>
                <defs>
                    <linearGradient id="appleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF6666;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#CC0000;stop-opacity:1" />
                    </linearGradient>
                </defs>
            </svg>
        `);
        
        // å‚™ç”¨è˜‹æœç¹ªè£½å‡½æ•¸ï¼ˆå¦‚æœåœ–åƒåŠ è¼‰å¤±æ•—ï¼‰
        function drawApple(x, y, size) {
            // è˜‹æœä¸»é«”
            ctx.fillStyle = '#FF3333';
            ctx.beginPath();
            ctx.ellipse(x, y, size * 0.4, size * 0.5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // è˜‹æœé«˜å…‰
            ctx.fillStyle = '#FF6666';
            ctx.beginPath();
            ctx.ellipse(x - size * 0.15, y - size * 0.1, size * 0.2, size * 0.25, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // è˜‹æœè–
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x - size * 0.05, y - size * 0.5, size * 0.1, size * 0.2);
            
            // è˜‹æœè‘‰å­
            ctx.fillStyle = '#33AA33';
            ctx.beginPath();
            ctx.ellipse(x + size * 0.05, y - size * 0.45, size * 0.15, size * 0.08, Math.PI/4, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // éŠæˆ²ç‹€æ…‹
        let snake = [];
        let food = {};
        let direction = 'right';
        let nextDirection = 'right';
        let gameSpeed = 150; // åˆå§‹é€Ÿåº¦ï¼ˆæ¯«ç§’ï¼‰
        let score = 0;
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        let level = 1;
        let gameRunning = false;
        let gamePaused = false;
        let gameLoop;
        let appleLoaded = false;
        let activeTouchDirection = null; // ç•¶å‰è§¸æ§çš„æ–¹å‘
        
        // ç›£è½è˜‹æœåœ–åƒåŠ è¼‰
        appleImage.onload = function() {
            appleLoaded = true;
        };
        
        appleImage.onerror = function() {
            appleLoaded = false;
            console.log("è˜‹æœåœ–åƒåŠ è¼‰å¤±æ•—ï¼Œä½¿ç”¨ç¹ªè£½å‡½æ•¸");
        };
        
        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            // åˆå§‹åŒ–è²ªåƒè›‡
            snake = [
                {x: 10, y: 10},
                {x: 9, y: 10},
                {x: 8, y: 10}
            ];
            
            // ç”Ÿæˆé£Ÿç‰©
            generateFood();
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            direction = 'right';
            nextDirection = 'right';
            score = 0;
            level = 1;
            gameSpeed = 150;
            activeTouchDirection = null;
            
            // ç§»é™¤æ‰€æœ‰æ–¹å‘æŒ‰éˆ•çš„æ¿€æ´»ç‹€æ…‹
            directionElements.forEach(el => {
                el.classList.remove('active');
            });
            
            // æ›´æ–°UI
            updateScore();
            highScoreElement.textContent = highScore;
            levelElement.textContent = level;
            
            // éš±è—éŠæˆ²çµæŸå±å¹•
            gameOverScreen.style.display = 'none';
            
            // ç¹ªè£½åˆå§‹ç‹€æ…‹
            draw();
        }
        
        // ç”Ÿæˆé£Ÿç‰©
        function generateFood() {
            // éš¨æ©Ÿç”Ÿæˆé£Ÿç‰©ä½ç½®
            food = {
                x: Math.floor(Math.random() * GRID_WIDTH),
                y: Math.floor(Math.random() * GRID_HEIGHT)
            };
            
            // ç¢ºä¿é£Ÿç‰©ä¸æœƒç”Ÿæˆåœ¨è›‡èº«ä¸Š
            for (let segment of snake) {
                if (segment.x === food.x && segment.y === food.y) {
                    return generateFood(); // é‡æ–°ç”Ÿæˆ
                }
            }
        }
        
        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        function update() {
            // æ›´æ–°è›‡çš„æ–¹å‘
            direction = nextDirection;
            
            // è¨ˆç®—æ–°çš„è›‡é ­ä½ç½®
            const head = {...snake[0]};
            
            switch(direction) {
                case 'up': head.y--; break;
                case 'down': head.y++; break;
                case 'left': head.x--; break;
                case 'right': head.x++; break;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ’ç‰†
            if (head.x < 0 || head.x >= GRID_WIDTH || head.y < 0 || head.y >= GRID_HEIGHT) {
                gameOver();
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ’åˆ°è‡ªå·±
            for (let segment of snake) {
                if (head.x === segment.x && head.y === segment.y) {
                    gameOver();
                    return;
                }
            }
            
            // å°‡æ–°çš„é ­éƒ¨æ·»åŠ åˆ°è›‡èº«
            snake.unshift(head);
            
            // æª¢æŸ¥æ˜¯å¦åƒåˆ°è˜‹æœ
            if (head.x === food.x && head.y === food.y) {
                // å¢åŠ åˆ†æ•¸
                score += 10;
                
                // æª¢æŸ¥æ˜¯å¦å‡ç´š
                const newLevel = Math.floor(score / 100) + 1;
                if (newLevel > level) {
                    level = newLevel;
                    // æ¯å‡ä¸€ç´šé€Ÿåº¦å¢åŠ 10%ï¼ˆä½†ä¿è­‰æœ€å°é€Ÿåº¦ç‚º50msï¼‰
                    gameSpeed = Math.max(50, gameSpeed * 0.9);
                    
                    // é¡¯ç¤ºç­‰ç´šæå‡æç¤º
                    showLevelUp();
                    
                    // é‡è¦ä¿®å¾©ï¼šæ›´æ–°éŠæˆ²å¾ªç’°é€Ÿåº¦
                    if (gameLoop) {
                        clearInterval(gameLoop);
                        gameLoop = setInterval(gameStep, gameSpeed);
                    }
                }
                
                // æ›´æ–°UI
                updateScore();
                
                // æ’­æ”¾åƒè˜‹æœéŸ³æ•ˆï¼ˆæ¨¡æ“¬ï¼‰
                playEatSound();
                
                // ç”Ÿæˆæ–°è˜‹æœ
                generateFood();
            } else {
                // å¦‚æœæ²’æœ‰åƒåˆ°è˜‹æœï¼Œç§»é™¤å°¾éƒ¨
                snake.pop();
            }
        }
        
        // é¡¯ç¤ºç­‰ç´šæå‡æç¤º
        function showLevelUp() {
            levelUpElement.textContent = `ç­‰çº§ ${level}!`;
            levelUpElement.style.opacity = '1';
            
            setTimeout(() => {
                levelUpElement.style.opacity = '0';
            }, 1000);
        }
        
        // æ’­æ”¾åƒè˜‹æœéŸ³æ•ˆï¼ˆæ¨¡æ“¬ï¼‰
        function playEatSound() {
            try {
                // å‰µå»ºä¸€å€‹ç°¡å–®çš„éŸ³æ•ˆ
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // å¦‚æœéŸ³é »APIä¸å¯ç”¨ï¼Œéœé»˜å¤±æ•—
                console.log("éŸ³é »APIä¸å¯ç”¨");
            }
        }
        
        // ç¹ªè£½éŠæˆ²
        function draw() {
            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#0d1b2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç¹ªè£½ç¶²æ ¼ç·š
            ctx.strokeStyle = '#1b3a4b';
            ctx.lineWidth = 0.5;
            
            // ç¹ªè£½å‚ç›´ç·š
            for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // ç¹ªè£½æ°´å¹³ç·š
            for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // ç¹ªè£½è›‡
            snake.forEach((segment, index) => {
                // è›‡é ­
                if (index === 0) {
                    ctx.fillStyle = '#4dff91';
                    ctx.fillRect(segment.x * GRID_SIZE, segment.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
                    
                    // è›‡é ­å…§éƒ¨é¡è‰²
                    ctx.fillStyle = '#33cc73';
                    ctx.fillRect(
                        segment.x * GRID_SIZE + 4, 
                        segment.y * GRID_SIZE + 4, 
                        GRID_SIZE - 8, 
                        GRID_SIZE - 8
                    );
                    
                    // ç¹ªè£½çœ¼ç›
                    ctx.fillStyle = '#000';
                    let eyeSize = 3;
                    let eyeOffset = 5;
                    
                    // æ ¹æ“šæ–¹å‘èª¿æ•´çœ¼ç›ä½ç½®
                    if (direction === 'right') {
                        ctx.fillRect(
                            segment.x * GRID_SIZE + GRID_SIZE - eyeOffset, 
                            segment.y * GRID_SIZE + eyeOffset, 
                            eyeSize, eyeSize
                        );
                        ctx.fillRect(
                            segment.x * GRID_SIZE + GRID_SIZE - eyeOffset, 
                            segment.y * GRID_SIZE + GRID_SIZE - eyeOffset - eyeSize, 
                            eyeSize, eyeSize
                        );
                    } else if (direction === 'left') {
                        ctx.fillRect(
                            segment.x * GRID_SIZE + eyeOffset, 
                            segment.y * GRID_SIZE + eyeOffset, 
                            eyeSize, eyeSize
                        );
                        ctx.fillRect(
                            segment.x * GRID_SIZE + eyeOffset, 
                            segment.y * GRID_SIZE + GRID_SIZE - eyeOffset - eyeSize, 
                            eyeSize, eyeSize
                        );
                    } else if (direction === 'up') {
                        ctx.fillRect(
                            segment.x * GRID_SIZE + eyeOffset, 
                            segment.y * GRID_SIZE + eyeOffset, 
                            eyeSize, eyeSize
                        );
                        ctx.fillRect(
                            segment.x * GRID_SIZE + GRID_SIZE - eyeOffset - eyeSize, 
                            segment.y * GRID_SIZE + eyeOffset, 
                            eyeSize, eyeSize
                        );
                    } else if (direction === 'down') {
                        ctx.fillRect(
                            segment.x * GRID_SIZE + eyeOffset, 
                            segment.y * GRID_SIZE + GRID_SIZE - eyeOffset - eyeSize, 
                            eyeSize, eyeSize
                        );
                        ctx.fillRect(
                            segment.x * GRID_SIZE + GRID_SIZE - eyeOffset - eyeSize, 
                            segment.y * GRID_SIZE + GRID_SIZE - eyeOffset - eyeSize, 
                            eyeSize, eyeSize
                        );
                    }
                } 
                // è›‡èº«
                else {
                    ctx.fillStyle = '#4dff91';
                    ctx.fillRect(segment.x * GRID_SIZE, segment.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
                    
                    // è›‡èº«å…§éƒ¨é¡è‰²
                    ctx.fillStyle = '#33cc73';
                    ctx.fillRect(
                        segment.x * GRID_SIZE + 2, 
                        segment.y * GRID_SIZE + 2, 
                        GRID_SIZE - 4, 
                        GRID_SIZE - 4
                    );
                }
            });
            
            // ç¹ªè£½è˜‹æœ
            const appleX = food.x * GRID_SIZE + GRID_SIZE / 2;
            const appleY = food.y * GRID_SIZE + GRID_SIZE / 2;
            const appleSize = GRID_SIZE * 0.8;
            
            if (appleLoaded) {
                // ä½¿ç”¨è˜‹æœåœ–åƒ
                ctx.drawImage(appleImage, appleX - appleSize/2, appleY - appleSize/2, appleSize, appleSize);
            } else {
                // ä½¿ç”¨ç¹ªè£½çš„è˜‹æœ
                drawApple(appleX, appleY, appleSize);
            }
            
            // å¦‚æœéŠæˆ²æš«åœï¼Œé¡¯ç¤ºæš«åœæ–‡å­—
            if (gamePaused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.font = 'bold 40px Arial';
                ctx.fillStyle = '#4dff91';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('éŠæˆ²æš«åœ', canvas.width / 2, canvas.height / 2);
                
                ctx.font = '20px Arial';
                ctx.fillStyle = '#fff';
                ctx.fillText('æŒ‰ç©ºæ ¼éµæˆ–é»æ“Š"ç¹¼çºŒéŠæˆ²"æŒ‰éˆ•ç¹¼çºŒ', canvas.width / 2, canvas.height / 2 + 50);
            }
        }
        
        // éŠæˆ²ä¸»å¾ªç’°
        function gameStep() {
            if (!gamePaused && gameRunning) {
                update();
                draw();
            }
        }
        
        // é–‹å§‹éŠæˆ²å¾ªç’°
        function startGame() {
            if (!gameRunning) {
                gameRunning = true;
                gamePaused = false;
                
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„èˆŠå¾ªç’°
                if (gameLoop) {
                    clearInterval(gameLoop);
                }
                
                // é–‹å§‹æ–°å¾ªç’°
                gameLoop = setInterval(gameStep, gameSpeed);
                startButton.textContent = "éŠæˆ²é€²è¡Œä¸­";
            } else if (gamePaused) {
                // å¦‚æœéŠæˆ²æš«åœï¼Œå‰‡ç¹¼çºŒéŠæˆ²
                gamePaused = false;
                pauseButton.textContent = "æš«åœéŠæˆ²";
            }
        }
        
        // æš«åœéŠæˆ²
        function pauseGame() {
            if (gameRunning && !gamePaused) {
                gamePaused = true;
                pauseButton.textContent = "ç¹¼çºŒéŠæˆ²";
                draw(); // é‡ç¹ªä»¥é¡¯ç¤ºæš«åœæ–‡æœ¬
            } else if (gamePaused) {
                gamePaused = false;
                pauseButton.textContent = "æš«åœéŠæˆ²";
            }
        }
        
        // éŠæˆ²çµæŸ
        function gameOver() {
            gameRunning = false;
            clearInterval(gameLoop);
            
            // ç§»é™¤æ‰€æœ‰æ–¹å‘æŒ‰éˆ•çš„æ¿€æ´»ç‹€æ…‹
            directionElements.forEach(el => {
                el.classList.remove('active');
            });
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
                highScoreElement.textContent = highScore;
            }
            
            // é¡¯ç¤ºéŠæˆ²çµæŸå±å¹•
            finalScoreElement.textContent = score;
            gameOverScreen.style.display = 'flex';
            
            // æ›´æ–°æŒ‰éˆ•æ–‡æœ¬
            startButton.textContent = "é–‹å§‹éŠæˆ²";
        }
        
        // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
        function updateScore() {
            scoreElement.textContent = score;
            levelElement.textContent = level;
        }
        
        // è§¸æ§æ–¹å‘è™•ç†å‡½æ•¸
        function handleTouchDirection(newDirection) {
            // æª¢æŸ¥æ–¹å‘æ˜¯å¦æœ‰æ•ˆï¼ˆé˜²æ­¢180åº¦æ€¥è½‰ï¼‰
            if ((newDirection === 'up' && direction !== 'down') ||
                (newDirection === 'down' && direction !== 'up') ||
                (newDirection === 'left' && direction !== 'right') ||
                (newDirection === 'right' && direction !== 'left')) {
                
                nextDirection = newDirection;
                activeTouchDirection = newDirection;
                
                // æ›´æ–°è¦–è¦ºåé¥‹
                updateDirectionVisualFeedback(newDirection);
            }
        }
        
        // æ›´æ–°æ–¹å‘è¦–è¦ºåé¥‹
        function updateDirectionVisualFeedback(dir) {
            // ç§»é™¤æ‰€æœ‰æ–¹å‘æŒ‰éˆ•çš„æ¿€æ´»ç‹€æ…‹
            directionElements.forEach(el => {
                el.classList.remove('active');
            });
            
            // æ¿€æ´»ç•¶å‰æ–¹å‘
            const activeElement = document.querySelector(`.direction[data-direction="${dir}"]`);
            if (activeElement) {
                activeElement.classList.add('active');
            }
        }
        
        // æ¸…é™¤æ–¹å‘è¦–è¦ºåé¥‹
        function clearDirectionVisualFeedback() {
            directionElements.forEach(el => {
                el.classList.remove('active');
            });
            activeTouchDirection = null;
        }
        
        // éµç›¤æ§åˆ¶
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (direction !== 'down') {
                        nextDirection = 'up';
                        clearDirectionVisualFeedback(); // æ¸…é™¤è§¸æ§åé¥‹
                    }
                    event.preventDefault();
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (direction !== 'up') {
                        nextDirection = 'down';
                        clearDirectionVisualFeedback();
                    }
                    event.preventDefault();
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (direction !== 'right') {
                        nextDirection = 'left';
                        clearDirectionVisualFeedback();
                    }
                    event.preventDefault();
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (direction !== 'left') {
                        nextDirection = 'right';
                        clearDirectionVisualFeedback();
                    }
                    event.preventDefault();
                    break;
                case ' ':
                    // ç©ºæ ¼éµæš«åœ/ç¹¼çºŒéŠæˆ²
                    if (gameRunning) {
                        pauseGame();
                    } else {
                        startGame();
                    }
                    event.preventDefault();
                    break;
                case 'Enter':
                    // å›è»Šéµé‡æ–°é–‹å§‹éŠæˆ²
                    if (!gameRunning) {
                        initGame();
                        startGame();
                    }
                    event.preventDefault();
                    break;
            }
        });
        
        // æŒ‰éˆ•äº‹ä»¶ç›£è½
        startButton.addEventListener('click', startGame);
        pauseButton.addEventListener('click', pauseGame);
        restartButton.addEventListener('click', () => {
            initGame();
            startGame();
        });
        restartButton2.addEventListener('click', () => {
            initGame();
            startGame();
        });
        
        // è§¸æ§é¢æ¿äº‹ä»¶è™•ç†
        directionElements.forEach(element => {
            // é»æ“Šäº‹ä»¶ï¼ˆç”¨æ–¼æ¡Œé¢ç«¯æ¸¬è©¦ï¼‰
            element.addEventListener('click', function(e) {
                if (!gameRunning) return;
                
                const dir = this.dataset.direction;
                handleTouchDirection(dir);
                e.preventDefault();
                e.stopPropagation();
            });
            
            // è§¸æ§é–‹å§‹äº‹ä»¶
            element.addEventListener('touchstart', function(e) {
                if (!gameRunning) return;
                
                const dir = this.dataset.direction;
                handleTouchDirection(dir);
                e.preventDefault();
                e.stopPropagation();
            });
            
            // è§¸æ§çµæŸäº‹ä»¶
            element.addEventListener('touchend', function(e) {
                // ä¸æ¸…é™¤è¦–è¦ºåé¥‹ï¼Œè®“ç©å®¶çŸ¥é“ä¸Šæ¬¡æ“ä½œçš„æ–¹å‘
                e.preventDefault();
                e.stopPropagation();
            });
            
            // é˜²æ­¢è§¸æ§å€åŸŸçš„é»˜èªè¡Œç‚º
            element.addEventListener('touchmove', function(e) {
                e.preventDefault();
            });
        });
        
        // æ•´å€‹è§¸æ§å€åŸŸçš„è§¸æ§çµæŸäº‹ä»¶
        touchArea.addEventListener('touchend', function(e) {
            // è§¸æ§çµæŸæ™‚ä¸æ¸…é™¤åé¥‹ï¼Œä¿æŒæœ€å¾Œæ“ä½œçš„æ–¹å‘
            e.preventDefault();
        });
        
        // é˜²æ­¢è§¸æ§å€åŸŸçš„é»˜èªè¡Œç‚º
        touchArea.addEventListener('touchmove', function(e) {
            e.preventDefault();
        });
        
        // åˆå§‹åŒ–éŠæˆ²
        initGame();
        highScoreElement.textContent = highScore;
        
        // é©æ‡‰ç§»å‹•ç«¯èª¿æ•´ç•«å¸ƒå¤§å°å’Œè§¸æ§é¢æ¿ä½ç½®
        function resizeCanvas() {
            const container = document.querySelector('.game-area');
            const containerWidth = container.clientWidth;
            
            if (containerWidth < 620) {
                const newWidth = containerWidth - 20;
                const aspectRatio = canvas.height / canvas.width;
                canvas.width = newWidth;
                canvas.height = newWidth * aspectRatio;
            } else {
                canvas.width = 600;
                canvas.height = 400;
            }
            
            // é‡æ–°ç¹ªè£½
            if (gameRunning || !gameRunning) {
                draw();
            }
        }
        
        // åˆå§‹èª¿æ•´å’Œçª—å£å¤§å°è®ŠåŒ–æ™‚èª¿æ•´
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);
        
        // æ·»åŠ ä¸€å€‹èª¿è©¦å‡½æ•¸ï¼Œå¯ä»¥æŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
        window.debugGame = function() {
            console.log('éŠæˆ²ç‹€æ…‹:', {
                score: score,
                level: level,
                gameSpeed: gameSpeed,
                gameRunning: gameRunning,
                gamePaused: gamePaused,
                snakeLength: snake.length,
                foodPosition: food,
                currentDirection: direction,
                nextDirection: nextDirection,
                activeTouchDirection: activeTouchDirection
            });
        };
    </script>
</body>
</html>